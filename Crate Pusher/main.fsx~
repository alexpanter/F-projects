// This is the main file of the game Crate Pusher.

open System.Drawing
open System.Windows.Forms

#load "maps/maps.fsx"
#load "visuals.fs"
#load "movement.fs"


let brick = visuals.defaultBrickWall()
let crate = visuals.defaultCrate()
let target = visuals.defaultCrateTarget()

let charUp = visuals.characterUp()
let charDown = visuals.characterDown()
let charLeft = visuals.characterLeft()
let charRight = visuals.characterRight()
let direction = ref (1,0)
let coordinate = ref (0,0)
let getDirection() =
    match !direction with
        | (1,0)  -> charRight
        | (0,1)  -> charDown
        | (-1,0) -> charLeft
        | (0,-1) -> charUp
        | _ as v -> failwithf "getDirection received invalid vector: %A" v

let f = visuals.createMainForm()
let rect(l: Point, s: int) = Rectangle(l,Size(s,s))

let allLevels = maps.levels
let numLevels = List.length allLevels

let levelWon = ref false
let gameOver = ref false

let thisLevelNumber = ref 0
let mutable thisLevel = allLevels.[!thisLevelNumber]()
let mutable pixelSize = f.ClientSize.Width / thisLevel.Size
let gotoNextLevel() =
    if !thisLevelNumber = numLevels - 1 then
        gameOver := true
    else
        thisLevelNumber := !thisLevelNumber + 1
        thisLevel <- allLevels.[!thisLevelNumber]()
        pixelSize <- f.ClientSize.Width / thisLevel.Size





// handlers defined for the main form
f.KeyUp.AddHandler(new KeyEventHandler
    (fun s e ->
         let i,j = !coordinate
         let x,y = !direction
         let l = thisLevel
         match e.KeyValue with
             | 38 ->     // up
                 if (x,y) = (0,-1) then
                     if movement.checkMove((i,j), (x,y), l.Map, l.Size) then
                         printfn "true up"
                         l.Map.[i,j] <- 0
                         l.Map.[i+y,j+x] <- 5
                 else
                     direction := (0,-1) 
                 f.Refresh()
             | 40 ->     // down
                 if (x,y) = (0,1) then
                     if movement.checkMove((i,j), (x,y), l.Map, l.Size) then
                         printfn "true down"
                         l.Map.[i,j] <- 0
                         l.Map.[i+y,j+x] <- 5
                 else
                     direction := (0,1)
                 f.Refresh()
             | 37 ->     // left
                 if (x,y) = (-1,0) then
                     if movement.checkMove((i,j), (x,y), l.Map, l.Size) then
                         printfn "true left"
                         l.Map.[i,j] <- 0
                         l.Map.[i+y,j+x] <- 5
                 else
                     direction := (-1,0)
                 f.Refresh()
             | 39 ->     // right
                 if (x,y) = (1,0) then
                     if movement.checkMove((i,j), (x,y), l.Map, l.Size) then
                         printfn "true right"
                         l.Map.[i,j] <- 0
                         l.Map.[i+y,j+x] <- 5
                 else
                     direction := (1,0)
                 f.Refresh()
             | 27 ->     // escape
                 f.Close()
             | _ -> ()
         printfn "%A" e.KeyValue
     ))




// Paint event handler for the main form
f.Paint.Add(fun e ->
    let mutable targetsLeft = 0
    for i = 0 to (Array2D.length1 <| thisLevel.Map) - 1 do
        for j = 0 to (Array2D.length2 <| thisLevel.Map) - 1 do
            match thisLevel.Map.[i,j] with
            | 0 -> () //empty space
            | 1 -> e.Graphics.DrawImage
                       (brick,
                        rect(Point(j * pixelSize,i * pixelSize), pixelSize))
            | 2 -> e.Graphics.DrawImage
                       (crate,
                        rect(Point(j * pixelSize,i * pixelSize), pixelSize))
            | 3 -> e.Graphics.DrawImage
                       (target,
                        rect(Point(j * pixelSize,i * pixelSize), pixelSize))
                   targetsLeft <- targetsLeft + 1
            | 4 -> () //not defined!
            | 5 -> e.Graphics.DrawImage
                       (getDirection(),
                        rect(Point(j * pixelSize,i * pixelSize), pixelSize))
                   coordinate := (i,j)
            
            | _ as k-> failwithf "paint event received illegal integer code: %i" k
    printfn "targets left: %d" targetsLeft
    printfn "player direction: %A" !direction
    )



// Running the application
Application.Run(f)

